<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gas CRN Tracker - Live Database (TypeScript Version)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- SheetJS for Excel handling -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #00796B; --secondary-color: #FFC107; --danger-color: #D32F2F;
            --light-bg: #F4F6F8; --white-bg: #FFFFFF; --dark-text: #333333;
            --muted-text: #6c757d; --border-color: #e0e0e0; --font-family: 'Poppins', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--light-bg); color: var(--dark-text); font-family: var(--font-family); line-height: 1.6; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        .card { background: var(--white-bg); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.04); padding: 25px; margin-bottom: 25px; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; font-size: 16px; font-weight: 500; text-align: center; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; text-decoration: none; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: var(--dark-text); }
        .btn-outline { background-color: transparent; border: 2px solid var(--primary-color); color: var(--primary-color); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-sm { padding: 8px 16px; font-size: 14px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; margin-bottom: 30px; position: relative; }
        .header-content { text-align: center; flex-grow: 1; }
        .header h1 { font-size: 36px; font-weight: 600; color: var(--dark-text); margin-bottom: 10px; }
        .header-content p { font-size: 18px; color: var(--muted-text); }
        .back-btn, .manager-login-btn { background: #fff; border: 1px solid var(--border-color); color: var(--muted-text); border-radius: 8px; height: 40px; padding: 0 15px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .back-btn:hover, .manager-login-btn:hover { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .page { display: none; } .page.active { display: block; }
        .crn-item { border: 1px solid var(--border-color); border-radius: 10px; padding: 20px; margin-bottom: 15px; background-color: #fdfdfd; transition: all 0.2s ease-out; }
        .crn-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .crn-id { font-weight: 600; font-size: 20px; color: var(--primary-color); }
        .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 500; border: 1px solid; }
        .status-unknown { background-color: #fff8e1; border-color: #ffe082; color: #795548;}
        .status-site { background-color: #ede7f6; border-color: #d1c4e9; color: #4527a0;}
        .status-field { background-color: #e3f2fd; border-color: #90caf9; color: #0d47a1; }
        .status-map { background-color: #e8f5e9; border-color: #a5d6a7; color: #1b5e20; }
        .status-danger { background-color: #ffebee; border-color: #ef9a9a; color: #c62828; }
        .crn-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .detail-item .detail-label { font-size: 13px; color: var(--muted-text); margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        .actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: flex-end; }
        .action-btn { flex: 1 1 180px; }
        .filter-section { background-color: var(--white-bg); border-radius: 12px; padding: 20px; margin-bottom: 25px; border-top: 4px solid var(--primary-color); }
        .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .filter-title { font-size: 20px; font-weight: 600; color: var(--dark-text); flex-grow: 1; }
        .filter-actions { display: flex; gap: 10px; }
        .filter-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .filter-select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 16px; background-color: var(--light-bg); appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: left 0.75rem center; background-size: 16px 12px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; }
        .modal-content h3 { margin-bottom: 20px; }
        .modal-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 16px; margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--light-bg); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .results-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 15px; background: var(--white-bg); border-radius: 12px; border: 1px solid var(--border-color); }
        .results-count { font-size: 16px; font-weight: 500; color: var(--primary-color); }
        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 20px 0; }
        .pagination-btn { padding: 8px 16px; border: 1px solid var(--border-color); background: var(--white-bg); color: var(--dark-text); border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .pagination-btn:hover { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-btn:disabled:hover { background: var(--white-bg); color: var(--dark-text); border-color: var(--border-color); }
        .page-size-selector { display: flex; align-items: center; gap: 10px; }
        .search-box { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 16px; background-color: var(--light-bg); margin-bottom: 15px; }
        .table-container { overflow-x: auto; }
        #buildings-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #buildings-table th, #buildings-table td { padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color); }
        #buildings-table th { background-color: var(--light-bg); font-weight: 600; }
        #buildings-table tr:hover { background-color: #f8f9fa; }
        .completed-row { background-color: #e8f5e9 !important; }

        .crn-item, .card, .filter-section, .results-info, .stat-card { animation: fadeIn 0.5s ease-in-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .crn-item:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.07); }
        
        .button-group-ux { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
        .btn-ux { display: flex; align-items: center; justify-content: space-between; padding: 20px 25px; font-size: 18px; border-radius: 12px; text-align: right; }
        .btn-ux-icon { margin-left: 15px; }
        .btn-ux-text { flex-grow: 1; }
        .btn-ux-badge { background-color: rgba(255, 255, 255, 0.2); padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 16px; min-width: 40px; text-align: center; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background-color: #fff; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--border-color); }
        .stat-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; margin: 0 auto 15px; }
        .stat-value { font-size: 28px; font-weight: 600; color: var(--dark-text); }
        .stat-label { font-size: 14px; color: var(--muted-text); }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay"><div class="loader"></div></div>

    <div class="container">
        <!-- Home Page -->
        <div id="home-page" class="page active">
            <div class="header">
                <div><button class="manager-login-btn" onclick="promptForManagerPassword()"><i class="fas fa-user-shield"></i> دخول المدير</button></div>
                <div class="header-content"><h1><i class="fas fa-fire"></i> Gas CRN Tracker</h1><p>نظام متابعة وتأكيد توصيل الغاز الطبيعي للمباني</p></div>
                <div style="width:110px"></div>
            </div>
            <div class="card">
                <h2 style="text-align: center; margin-bottom: 25px; font-weight: 600;">اختر واجهة المستخدم</h2>
                <div class="button-group-ux">
                    <button class="btn btn-primary btn-ux" onclick="showPage('main-page', 'office')">
                        <span class="btn-ux-icon"><i class="fas fa-building"></i></span>
                        <span class="btn-ux-text">المطلوب من المكتب</span>
                        <span id="office-task-count" class="btn-ux-badge">...</span>
                    </button>
                    <button class="btn btn-secondary btn-ux" onclick="showPage('main-page', 'field')">
                        <span class="btn-ux-icon"><i class="fas fa-hard-hat"></i></span>
                        <span class="btn-ux-text">المطلوب من الموقع</span>
                        <span id="field-task-count" class="btn-ux-badge">...</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Task Page (Office & Field) -->
        <div id="main-page" class="page">
             <div class="header"><button class="back-btn" onclick="showPage('home-page')"><i class="fas fa-arrow-right"></i> العودة</button><div class="header-content"><h1 id="user-type-label">مهام المستخدم</h1></div><div style="width: 100px;"></div></div>
            <div class="filter-section">
                <div class="filter-header">
                    <div class="filter-title"><i class="fas fa-filter"></i> تصفية المباني</div>
                    <div class="filter-actions"><button class="btn btn-sm btn-primary" onclick="exportCurrentView()"><i class="fas fa-file-excel"></i> تصدير</button></div>
                </div>
                <input type="text" id="search-box" class="search-box" placeholder="بحث بـ CRN أو اسم المحافظة أو المدينة..." oninput="debounceSearch()">
                <div class="filter-controls">
                    <div class="filter-group"><label class="filter-label">المحافظة</label><select id="governorate-filter" class="filter-select" onchange="updateCityFilter()"><option value="">جميع المحافظات</option></select></div>
                    <div class="filter-group"><label class="filter-label">المدينة</label><select id="city-filter" class="filter-select" onchange="updateSectorFilter()"><option value="">جميع المدن</option></select></div>
                    <div class="filter-group"><label class="filter-label">القطاع</label><select id="sector-filter" class="filter-select" onchange="updateBlockFilter()"><option value="">جميع القطاعات</option></select></div>
                    <div class="filter-group"><label class="filter-label">البلوك</label><select id="block-filter" class="filter-select" onchange="renderCRNList()"><option value="">جميع البلوكات</option></select></div>
                    <div class="filter-group page-size-selector">
                        <label class="filter-label">عدد النتائج لكل صفحة</label>
                        <select id="page-size" class="filter-select" onchange="changePageSize()">
                            <option value="20">20</option><option value="50" selected>50</option><option value="100">100</option><option value="all">الكل</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="results-info">
                <div class="results-count" id="results-count">عدد النتائج: 0</div>
                <div class="pagination-controls">
                    <button class="pagination-btn" id="prev-btn" onclick="previousPage()" disabled><i class="fas fa-chevron-right"></i></button>
                    <span id="page-info">صفحة 1 من 1</span>
                    <button class="pagination-btn" id="next-btn" onclick="nextPage()" disabled><i class="fas fa-chevron-left"></i></button>
                </div>
            </div>
            <div id="crn-list"><div class="card" style="text-align:center; color: var(--muted-text);">لا توجد مهام حالياً.</div></div>
        </div>
        
        <!-- Dashboard Page (Manager) -->
        <div id="dashboard-page" class="page">
            <div class="header"><button class="back-btn" onclick="showPage('home-page')"><i class="fas fa-arrow-right"></i> العودة</button><div class="header-content"><h1><i class="fas fa-chart-pie"></i> لوحة تحكم المدير</h1></div><div style="width: 100px;"></div></div>
            <div class="card"><h2 style="text-align: center; margin-bottom: 15px; font-weight: 600;">إدارة البيانات</h2><div class="button-group-ux" style="flex-direction: row; justify-content: center;"><label for="file-input" class="btn btn-primary"><i class="fas fa-file-import"></i> إضافة/تحديث بيانات</label><input type="file" id="file-input" onchange="handleFileUpload(event)" accept=".xlsx, .xls" style="display: none;"></div></div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background-color: #e8f5e9; color: #1b5e20;"><i class="fas fa-check-double"></i></div>
                    <div class="stat-value" id="stat-completed">0</div><div class="stat-label">مهام مكتملة</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background-color: #e3f2fd; color: #0d47a1;"><i class="fas fa-shipping-fast"></i></div>
                    <div class="stat-value" id="stat-at-field">0</div><div class="stat-label">قيد التنفيذ في الموقع</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background-color: #fff8e1; color: #795548;"><i class="fas fa-hourglass-half"></i></div>
                    <div class="stat-value" id="stat-at-office">0</div><div class="stat-label">قيد التنفيذ في المكتب</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background-color: #fbe9e7; color: #bf360c;"><i class="fas fa-building"></i></div>
                    <div class="stat-value" id="stat-total">0</div><div class="stat-label">إجمالي المباني</div>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-header">
                    <div class="filter-title"><i class="fas fa-cogs"></i> لوحة التحكم المفصلة</div>
                    <div class="filter-actions">
                        <button class="btn btn-sm btn-primary" onclick="exportCurrentView()"><i class="fas fa-file-excel"></i> تصدير</button>
                        <button class="btn btn-sm btn-outline" onclick="resetDashboardFilters()"><i class="fas fa-sync-alt"></i> إعادة تعيين</button>
                        <button class="btn btn-sm btn-danger" onclick="handleDeleteFilteredData()"><i class="fas fa-trash"></i> حذف المحدد</button>
                    </div>
                </div>
                <input type="text" id="dashboard-search" class="search-box" placeholder="بحث بـ CRN أو اسم المحافظة أو المدينة..." oninput="debounceDashboardSearch()">
                <div class="filter-controls">
                    <div class="filter-group"><label class="filter-label">المحافظة</label><select id="dashboard-governorate" class="filter-select" onchange="updateDashboardCityFilter()"><option value="">جميع المحافظات</option></select></div>
                    <div class="filter-group"><label class="filter-label">المدينة</label><select id="dashboard-city" class="filter-select" onchange="updateDashboardSectorFilter()"><option value="">جميع المدن</option></select></div>
                    <div class="filter-group"><label class="filter-label">القطاع</label><select id="dashboard-sector" class="filter-select" onchange="updateDashboardBlockFilter()"><option value="">جميع القطاعات</option></select></div>
                    <div class="filter-group"><label class="filter-label">البلوك</label><select id="dashboard-block" class="filter-select" onchange="renderDashboard()"><option value="">جميع البلوكات</option></select></div>
                    <div class="filter-group"><label class="filter-label">الحالة</label>
                        <select id="dashboard-status-filter" class="filter-select" onchange="renderDashboard()">
                            <option value="">جميع الحالات</option>
                            <option value="needs-office-action">تحتاج إجراء مكتبي</option>
                            <option value="needs-field-visit">تحتاج زيارة ميدانية</option>
                            <option value="field-confirmed">تم تأكيد الموقع</option>
                            <option value="map-confirmed">مكتمل</option>
                            <option value="site-issue-reported">تم الإبلاغ عن مشكلة</option>
                        </select>
                    </div>
                    <div class="filter-group"><label class="filter-label">نتائج لكل صفحة</label><select id="dashboard-page-size" class="filter-select" onchange="changeDashboardPageSize()"><option value="50">50</option><option value="100" selected>100</option><option value="200">200</option><option value="all">الكل</option></select></div>
                </div>
            </div>
            
            <div class="results-info">
                <div class="results-count" id="dashboard-results-count">عدد النتائج: 0</div>
                <div class="pagination-controls">
                    <button class="pagination-btn" id="dashboard-prev-btn" onclick="previousDashboardPage()" disabled><i class="fas fa-chevron-right"></i></button>
                    <span id="dashboard-page-info">صفحة 1 من 1</span>
                    <button class="pagination-btn" id="dashboard-next-btn" onclick="nextDashboardPage()" disabled><i class="fas fa-chevron-left"></i></button>
                </div>
            </div>
            
            <div class="card">
                <div class="table-container"><table id="buildings-table"><thead><tr><th>CRN</th><th>المحافظة</th><th>المدينة</th><th>القطاع</th><th>البلوك</th><th>الحالة</th></tr></thead><tbody></tbody></table><div id="dashboard-no-data" style="display:none; text-align:center; padding: 40px; color: var(--muted-text);"><i class="fas fa-table fa-3x" style="margin-bottom: 15px;"></i><h3>لا توجد بيانات للعرض</h3><p>جرب تغيير معايير التصفية أو قم باستيراد ملف بيانات جديد.</p></div></div>
            </div>
        </div>
        <div class="footer" style="text-align: center; margin-top: 40px; color: var(--muted-text); font-size: 14px;">Gas CRN Tracker &copy; 2024 - Live Edition (TS)</div>
    </div>

    <div id="manager-modal" class="modal-overlay"><div class="modal-content"><h3>دخول المدير</h3><p style="color: var(--muted-text); margin-bottom: 20px;">الرجاء إدخال كلمة المرور للوصول إلى لوحة التحكم.</p><input type="password" id="manager-password" class="modal-input" placeholder="كلمة المرور"><div class="modal-actions"><button class="btn btn-primary" onclick="checkManagerPassword()">دخول</button><button class="btn btn-outline" onclick="closeManagerPrompt()">إلغاء</button></div></div></div>

    <!-- NEW MODAL FOR PROBLEM DETAILS -->
    <div id="details-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>إضافة تفاصيل المشكلة</h3>
            <p style="color: var(--muted-text); margin-bottom: 20px;">الرجاء وصف المشكلة التي واجهتها في الموقع. هذا سيغلق المهمة بشكل نهائي.</p>
            <textarea id="problem-details-input" class="modal-input" placeholder="اكتب التفاصيل هنا..." rows="4" style="height: auto;"></textarea>
            <input type="hidden" id="modal-db-key-input">
            <div class="modal-actions">
                <button class="btn btn-danger" onclick="submitProblemDetails()">تأكيد وإغلاق المهمة</button>
                <button class="btn btn-outline" onclick="closeDetailsModal()">إلغاء</button>
            </div>
        </div>
    </div>


    <script>
        var firebase;
        var XLSX;
        
        const firebaseConfig = {
            apiKey: "AIzaSyCSF5d-WMW-aeLftxcHzbky84FwUMa_8rY",
            authDomain: "gas-connections.firebaseapp.com",
            databaseURL: "https://gas-connections-default-rtdb.firebaseio.com",
            projectId: "gas-connections",
            storageBucket: "gas-connections.firebasestorage.app",
            messagingSenderId: "406162505475",
            appId: "1:406162505475:web:77f31cb380ed065cb63336",
            measurementId: "G-M67G0QQN3W"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const dbRef = database.ref('/buildings');
        
        let buildingsData = [];
        let filteredData = [];
        let dashboardFilteredData = [];
        let currentUserType = "";
        let currentPage = 1, pageSize = 50, totalPages = 1;
        let dashboardCurrentPage = 1, dashboardPageSize = 100, dashboardTotalPages = 1;
        let searchTimeout;
        let dashboardSearchTimeout;
        let governorates = [];
        let cities = {};
        let sectors = {};
        let blocks = {};
        
        dbRef.on('value', (snapshot) => {
            const data = snapshot.val();
            buildingsData = data ? Object.keys(data).map(key => ({ ...data[key], db_key: key })) : [];
            document.getElementById('loading-overlay').style.display = 'none';
            initFilterData();
            refreshAllViews();
            updateHomepageTaskCounts();
            updateDashboardStats();
        }, (error) => {
            console.error("Firebase Read Error:", error);
            alert("فشل الاتصال بقاعدة البيانات.");
            document.getElementById('loading-overlay').style.display = 'none';
        });

        function refreshAllViews() {
            const activePageElement = document.querySelector('.page.active');
            if (!activePageElement) return;
            if (activePageElement.id === 'main-page') renderCRNList();
            else if (activePageElement.id === 'dashboard-page') renderDashboard();
        }

        function initFilterData() {
            governorates = [...new Set(buildingsData.map(b => b.governorate))].filter(Boolean);
            cities = {};
            sectors = {};
            blocks = {};
            governorates.forEach(gov => {
                cities[gov] = [...new Set(buildingsData.filter(b => b.governorate === gov).map(b => b.city))].filter(Boolean);
                cities[gov].forEach(city => {
                    const key = `${gov}-${city}`;
                    sectors[key] = [...new Set(buildingsData.filter(b => b.governorate === gov && b.city === city).map(b => b.sector))].filter(Boolean);
                    sectors[key].forEach(sector => {
                        blocks[`${key}-${sector}`] = [...new Set(buildingsData.filter(b => b.governorate === gov && b.city === city && b.sector === sector).map(b => b.block))].filter(Boolean);
                    });
                });
            });
            populateSelect('governorate-filter', governorates);
            populateSelect('dashboard-governorate', governorates);
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            const firstOption = select.querySelector('option[value=""]');
            const firstOptionText = firstOption ? firstOption.textContent : "الكل";
            select.innerHTML = `<option value="">${firstOptionText}</option>`;
            options.sort().forEach(opt => select.appendChild(new Option(opt, opt)));
        }

        function updateCityFilter() {
            const govFilter = document.getElementById('governorate-filter');
            populateSelect('city-filter', govFilter.value ? cities[govFilter.value] || [] : []);
            updateSectorFilter();
        }

        function updateDashboardCityFilter() {
            const govFilter = document.getElementById('dashboard-governorate');
            populateSelect('dashboard-city', govFilter.value ? cities[govFilter.value] || [] : []);
            updateDashboardSectorFilter();
        }

        function updateSectorFilter() {
            const gov = document.getElementById('governorate-filter').value;
            const city = document.getElementById('city-filter').value;
            populateSelect('sector-filter', (gov && city && sectors[`${gov}-${city}`]) ? sectors[`${gov}-${city}`] : []);
            updateBlockFilter();
        }

        function updateDashboardSectorFilter() {
            const gov = document.getElementById('dashboard-governorate').value;
            const city = document.getElementById('dashboard-city').value;
            populateSelect('dashboard-sector', (gov && city && sectors[`${gov}-${city}`]) ? sectors[`${gov}-${city}`] : []);
            updateDashboardBlockFilter();
        }

        function updateBlockFilter() {
            const gov = document.getElementById('governorate-filter').value;
            const city = document.getElementById('city-filter').value;
            const sec = document.getElementById('sector-filter').value;
            populateSelect('block-filter', (gov && city && sec && blocks[`${gov}-${city}-${sec}`]) ? blocks[`${gov}-${city}-${sec}`] : []);
            renderCRNList();
        }

        function updateDashboardBlockFilter() {
            const gov = document.getElementById('dashboard-governorate').value;
            const city = document.getElementById('dashboard-city').value;
            const sec = document.getElementById('dashboard-sector').value;
            populateSelect('dashboard-block', (gov && city && sec && blocks[`${gov}-${city}-${sec}`]) ? blocks[`${gov}-${city}-${sec}`] : []);
            renderDashboard();
        }

        function resetDashboardFilters() {
            document.getElementById('dashboard-search').value = "";
            document.getElementById('dashboard-governorate').value = "";
            updateDashboardCityFilter();
            document.getElementById('dashboard-status-filter').value = "";
            dashboardCurrentPage = 1;
            renderDashboard();
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => { currentPage = 1; renderCRNList(); }, 300);
        }

        function debounceDashboardSearch() {
            clearTimeout(dashboardSearchTimeout);
            dashboardSearchTimeout = setTimeout(() => { dashboardCurrentPage = 1; renderDashboard(); }, 300);
        }

        function showPage(pageId, userType = "") {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const pageElement = document.getElementById(pageId);
            if (pageElement) pageElement.classList.add('active');
            currentUserType = userType;
            if (pageId === 'main-page') {
                const userTypeLabel = document.getElementById('user-type-label');
                if (userTypeLabel) userTypeLabel.textContent = userType === 'office' ? 'المطلوب من المكتب' : 'المطلوب من الموقع';
                currentPage = 1;
                renderCRNList();
            } else if (pageId === 'dashboard-page') {
                dashboardCurrentPage = 1;
                renderDashboard();
            }
        }

        function applyFilters() {
            const govFilter = document.getElementById('governorate-filter').value;
            const cityFilter = document.getElementById('city-filter').value;
            const sectorFilter = document.getElementById('sector-filter').value;
            const blockFilter = document.getElementById('block-filter').value;
            const searchTerm = document.getElementById('search-box').value.toLowerCase();
            let data = buildingsData;

            if (currentUserType === 'office') {
                data = data.filter(b => !b.map_confirmed && (!b.needs_field_visit || b.site_confirmed));
            } else if (currentUserType === 'field') {
                data = data.filter(b => b.needs_field_visit && !b.site_confirmed && !b.site_issue_reported);
            }

            if (govFilter) data = data.filter(b => b.governorate === govFilter);
            if (cityFilter) data = data.filter(b => b.city === cityFilter);
            if (sectorFilter) data = data.filter(b => b.sector === sectorFilter);
            if (blockFilter) data = data.filter(b => b.block === blockFilter);

            if (searchTerm) {
                data = data.filter(b =>
                    (b.crn && b.crn.toString().toLowerCase().includes(searchTerm)) ||
                    (b.governorate && b.governorate.toLowerCase().includes(searchTerm)) ||
                    (b.city && b.city.toLowerCase().includes(searchTerm))
                );
            }
            return data;
        }

        function renderCRNList() {
            filteredData = applyFilters();
            const pageSizeSelector = document.getElementById('page-size');
            pageSize = pageSizeSelector.value === 'all' ? filteredData.length : parseInt(pageSizeSelector.value, 10) || 50;
            totalPages = Math.ceil(filteredData.length / pageSize) || 1;
            if (currentPage > totalPages) currentPage = totalPages;
            const pageData = filteredData.slice((currentPage - 1) * pageSize, currentPage * pageSize);
            
            document.getElementById('results-count').textContent = `النتائج: ${filteredData.length}`;
            updatePaginationControls('main');
            const listElement = document.getElementById('crn-list');
            listElement.innerHTML = '';

            if (pageData.length === 0) {
                listElement.innerHTML = `<div class="card" style="text-align:center; color: var(--muted-text);">لا توجد مهام حالياً.</div>`;
                return;
            }
            const fragment = document.createDocumentFragment();
            pageData.forEach(building => {
                const item = document.createElement('div');
                item.className = 'crn-item';
                item.innerHTML = generateCRNItemHTML(building);
                fragment.appendChild(item);
            });
            listElement.appendChild(fragment);
        }

        function generateCRNItemHTML(b) {
            let statusBadge = '';
            if (b.site_issue_reported) {
                statusBadge = '<span class="status-badge status-danger"><i class="fas fa-exclamation-circle"></i> تم الإبلاغ عن مشكلة</span>';
            } else if (b.map_confirmed) {
                statusBadge = '<span class="status-badge status-map"><i class="fas fa-check-circle"></i> مكتمل</span>';
            } else if (b.site_confirmed) {
                statusBadge = '<span class="status-badge status-site"><i class="fas fa-user-check"></i> تم تأكيد الموقع</span>';
            } else if (b.needs_field_visit) {
                statusBadge = '<span class="status-badge status-field"><i class="fas fa-shipping-fast"></i> مرسل للموقع</span>';
            } else {
                statusBadge = '<span class="status-badge status-unknown"><i class="fas fa-hourglass-start"></i> بانتظار المكتب</span>';
            }

            let actionsHTML = '';
            if (currentUserType === 'office') {
                if (!b.map_confirmed) {
                     if (b.site_confirmed) {
                        actionsHTML = `<button class="btn btn-primary action-btn" onclick="confirmOnMap('${b.db_key}')"><i class="fas fa-map-marked-alt"></i> تأكيد نهائي على الخريطة</button>`;
                    } else {
                        actionsHTML = `<button class="btn btn-primary action-btn" onclick="confirmOnMap('${b.db_key}')"><i class="fas fa-map-marked-alt"></i> تأكيد على الخريطة</button><button class="btn btn-secondary action-btn" onclick="sendToField('${b.db_key}')"><i class="fas fa-route"></i> إرسال للموقع</button>`;
                    }
                }
            } else if (currentUserType === 'field' && b.needs_field_visit && !b.site_confirmed && !b.site_issue_reported) {
                actionsHTML = `
                    <button class="btn btn-primary action-btn" onclick="confirmSiteVisit('${b.db_key}')"><i class="fas fa-check"></i> تأكيد الزيارة الميدانية</button>
                    <button class="btn btn-danger action-btn" onclick="openDetailsModal('${b.db_key}')"><i class="fas fa-exclamation-triangle"></i> الإبلاغ عن مشكلة</button>
                `;
            }

            return `<div class="crn-header"><span class="crn-id">${b.crn}</span>${statusBadge}</div><div class="crn-details"><div class="detail-item"><div class="detail-label"><i class="fas fa-globe-africa"></i> المحافظة</div><div>${b.governorate || 'N/A'}</div></div><div class="detail-item"><div class="detail-label"><i class="fas fa-city"></i> المدينة</div><div>${b.city || 'N/A'}</div></div><div class="detail-item"><div class="detail-label"><i class="fas fa-th-large"></i> القطاع</div><div>${b.sector || 'N/A'}</div></div><div class="detail-item"><div class="detail-label"><i class="fas fa-landmark"></i> البلوك</div><div>${b.block || 'N/A'}</div></div></div>${actionsHTML ? `<div class="actions">${actionsHTML}</div>` : ''}`;
        }
        
        function applyDashboardFilters() {
            const govFilter = document.getElementById('dashboard-governorate').value;
            const cityFilter = document.getElementById('dashboard-city').value;
            const sectorFilter = document.getElementById('dashboard-sector').value;
            const blockFilter = document.getElementById('dashboard-block').value;
            const statusFilter = document.getElementById('dashboard-status-filter').value;
            const searchTerm = document.getElementById('dashboard-search').value.toLowerCase();
            let data = buildingsData;
            
            if (govFilter) data = data.filter(b => b.governorate === govFilter);
            if (cityFilter) data = data.filter(b => b.city === cityFilter);
            if (sectorFilter) data = data.filter(b => b.sector === sectorFilter);
            if (blockFilter) data = data.filter(b => b.block === blockFilter);
            
            if (statusFilter) {
                if (statusFilter === 'needs-office-action') {
                    data = data.filter(b => !b.map_confirmed && !b.needs_field_visit && !b.site_confirmed && !b.site_issue_reported);
                } else if (statusFilter === 'needs-field-visit') {
                    data = data.filter(b => b.needs_field_visit && !b.site_confirmed && !b.site_issue_reported);
                } else if (statusFilter === 'field-confirmed') {
                    data = data.filter(b => b.site_confirmed && !b.map_confirmed);
                } else if (statusFilter === 'map-confirmed') {
                    data = data.filter(b => b.map_confirmed);
                } else if (statusFilter === 'site-issue-reported') {
                    data = data.filter(b => b.site_issue_reported);
                }
            }

            if (searchTerm) {
                data = data.filter(b => (b.crn && b.crn.toString().toLowerCase().includes(searchTerm)) ||
                    (b.governorate && b.governorate.toLowerCase().includes(searchTerm)) ||
                    (b.city && b.city.toLowerCase().includes(searchTerm)));
            }
            return data;
        }
        
        function renderDashboard() {
            updateDashboardStats();
            dashboardFilteredData = applyDashboardFilters();
            const pageSizeSelector = document.getElementById('dashboard-page-size');
            dashboardPageSize = pageSizeSelector.value === 'all' ? dashboardFilteredData.length : parseInt(pageSizeSelector.value, 10) || 100;
            dashboardTotalPages = Math.ceil(dashboardFilteredData.length / dashboardPageSize) || 1;
            if (dashboardCurrentPage > dashboardTotalPages) dashboardCurrentPage = dashboardTotalPages;
            const pageData = dashboardFilteredData.slice((dashboardCurrentPage - 1) * dashboardPageSize, dashboardCurrentPage * dashboardPageSize);
            document.getElementById('dashboard-results-count').textContent = `النتائج: ${dashboardFilteredData.length}`;
            updatePaginationControls('dashboard');
            const tableBody = document.querySelector("#buildings-table tbody");
            const noDataEl = document.getElementById('dashboard-no-data');
            tableBody.innerHTML = '';
            if (pageData.length === 0) {
                noDataEl.style.display = 'block';
                return;
            }
            noDataEl.style.display = 'none';
            const fragment = document.createDocumentFragment();
            pageData.forEach(b => {
                const row = document.createElement('tr');
                let statusText = 'تحتاج إجراء مكتبي';
                if (b.map_confirmed) { statusText = 'مكتمل'; row.classList.add('completed-row'); }
                else if (b.site_issue_reported) { statusText = `مشكلة: ${b.site_issue_details || ''}`; }
                else if (b.site_confirmed) { statusText = 'تم تأكيد الموقع'; }
                else if (b.needs_field_visit) { statusText = 'تحتاج زيارة ميدانية'; }
                row.innerHTML = `<td>${b.crn}</td><td>${b.governorate || ''}</td><td>${b.city || ''}</td><td>${b.sector || ''}</td><td>${b.block || ''}</td><td>${statusText}</td>`;
                fragment.appendChild(row);
            });
            tableBody.appendChild(fragment);
        }

        function updatePaginationControls(view) {
            const prefix = view === 'main' ? '' : 'dashboard-';
            const pageInfo = document.getElementById(`${prefix}page-info`);
            const prevBtn = document.getElementById(`${prefix}prev-btn`);
            const nextBtn = document.getElementById(`${prefix}next-btn`);
            const current = view === 'main' ? currentPage : dashboardCurrentPage;
            const total = view === 'main' ? totalPages : dashboardTotalPages;
            if (pageInfo) pageInfo.textContent = `صفحة ${current || 1} من ${total || 1}`;
            if (prevBtn) prevBtn.disabled = current <= 1;
            if (nextBtn) nextBtn.disabled = current >= total;
        }
        
        function nextPage() { if (currentPage < totalPages) { currentPage++; renderCRNList(); } }
        function previousPage() { if (currentPage > 1) { currentPage--; renderCRNList(); } }
        function changePageSize() { currentPage = 1; renderCRNList(); }
        function nextDashboardPage() { if (dashboardCurrentPage < dashboardTotalPages) { dashboardCurrentPage++; renderDashboard(); } }
        function previousDashboardPage() { if (dashboardCurrentPage > 1) { dashboardCurrentPage--; renderDashboard(); } }
        function changeDashboardPageSize() { dashboardCurrentPage = 1; renderDashboard(); }
        
        function confirmOnMap(db_key) { database.ref('/buildings/' + db_key).update({ map_confirmed: true, map_timestamp: new Date().toISOString() }); }
        function sendToField(db_key) { database.ref('/buildings/' + db_key).update({ needs_field_visit: true }); }
        function confirmSiteVisit(db_key) { database.ref('/buildings/' + db_key).update({ site_confirmed: true, site_timestamp: new Date().toISOString() }); }
        
        function updateHomepageTaskCounts() {
            const officeTasks = buildingsData.filter(b => !b.map_confirmed && (!b.needs_field_visit || b.site_confirmed)).length;
            document.getElementById('office-task-count').textContent = officeTasks.toString();
            
            const fieldTasks = buildingsData.filter(b => b.needs_field_visit && !b.site_confirmed && !b.site_issue_reported).length;
            document.getElementById('field-task-count').textContent = fieldTasks.toString();
        }

        function updateDashboardStats() {
            document.getElementById('stat-total').textContent = buildingsData.length.toString();
            document.getElementById('stat-completed').textContent = buildingsData.filter(b => b.map_confirmed).length.toString();
            document.getElementById('stat-at-field').textContent = buildingsData.filter(b => b.needs_field_visit && !b.site_confirmed && !b.site_issue_reported).length.toString();
            const officeQueue = buildingsData.filter(b => !b.map_confirmed && (!b.needs_field_visit || b.site_confirmed) && !b.site_issue_reported).length;
            document.getElementById('stat-at-office').textContent = officeQueue.toString();
        }

        function handleFileUpload(event) {
            const file = event.target.files?.[0];
            if (!file) return;
            document.getElementById('loading-overlay').style.display = 'flex';
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const arrayBuffer = e.target?.result;
                    if (!arrayBuffer) throw new Error('فشل قراءة الملف.');
                    const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                    if (jsonData.length < 2) throw new Error('الملف فارغ أو غير صالح.');
                    const headers = jsonData[0].map(h => h.toString().toLowerCase().trim());
                    const crnIndex = headers.indexOf('crn');
                    if (crnIndex === -1) throw new Error('الملف يجب أن يحتوي على عمود باسم "crn".');
                    
                    const updates = {};
                    const allCrns = new Set(buildingsData.map(b => b.crn.toString()));
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const crn = row[crnIndex] ? row[crnIndex].toString() : null;
                        if (!crn || allCrns.has(crn)) continue;
                        const newRecord = { crn: crn };
                        headers.forEach((h, idx) => {
                            if (h !== 'crn' && row[idx] !== undefined) {
                                newRecord[h] = row[idx];
                            }
                        });
                        const newKey = dbRef.push().key;
                        if (newKey) updates[newKey] = newRecord;
                    }
                    if (Object.keys(updates).length > 0) {
                        dbRef.update(updates).then(() => {
                            alert(`تمت إضافة ${Object.keys(updates).length} سجل جديد بنجاح.`);
                            document.getElementById('loading-overlay').style.display = 'none';
                        });
                    } else {
                        alert("لم يتم العثور على سجلات جديدة لإضافتها.");
                        document.getElementById('loading-overlay').style.display = 'none';
                    }
                } catch (error) {
                    alert(`خطأ: ${error.message}`);
                    document.getElementById('loading-overlay').style.display = 'none';
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        function handleDeleteFilteredData() {
            if (dashboardFilteredData.length === 0) {
                alert("يرجى تحديد البيانات المراد حذفها باستخدام الفلاتر أولاً.");
                return;
            }
            if (!confirm(`هل أنت متأكد من حذف ${dashboardFilteredData.length} سجل/سجلات المحددة نهائياً؟`)) {
                return;
            }
            document.getElementById('loading-overlay').style.display = 'flex';
            const updates = {};
            dashboardFilteredData.forEach(r => { updates[r.db_key] = null; });
            dbRef.update(updates).then(() => {
                alert(`تم حذف ${dashboardFilteredData.length} سجل بنجاح.`);
                document.getElementById('loading-overlay').style.display = 'none';
            }).catch(e => {
                alert(`فشل الحذف: ${e.message}`);
                document.getElementById('loading-overlay').style.display = 'none';
            });
        }
        
        function exportCurrentView() {
            let dataToExport = [];
            const activePage = document.querySelector('.page.active');
            if (!activePage) return;
            if (activePage.id === 'main-page') dataToExport = filteredData;
            else if (activePage.id === 'dashboard-page') dataToExport = dashboardFilteredData;
            if (dataToExport.length === 0) {
                alert("لا توجد بيانات لتصديرها.");
                return;
            }
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Data");
            XLSX.writeFile(workbook, "GasCRN_Export.xlsx");
        }
        
        function promptForManagerPassword() {
            const modal = document.getElementById('manager-modal');
            const passwordInput = document.getElementById('manager-password');
            if (modal) modal.style.display = 'flex';
            if (passwordInput) passwordInput.focus();
        }
        
        function closeManagerPrompt() {
            const modal = document.getElementById('manager-modal');
            const passwordInput = document.getElementById('manager-password');
            if (modal) modal.style.display = 'none';
            if (passwordInput) passwordInput.value = '';
        }
        
        function checkManagerPassword() {
            const passwordInput = document.getElementById('manager-password');
            if (passwordInput?.value === "Admin@123") {
                closeManagerPrompt();
                showPage('dashboard-page');
            } else {
                alert("كلمة مرور غير صحيحة!");
            }
        }

        // --- NEW FUNCTIONS FOR PROBLEM REPORTING ---
        function openDetailsModal(db_key) {
            document.getElementById('modal-db-key-input').value = db_key;
            const modal = document.getElementById('details-modal');
            if (modal) modal.style.display = 'flex';
        }

        function closeDetailsModal() {
            const modal = document.getElementById('details-modal');
            if (modal) modal.style.display = 'none';
            document.getElementById('problem-details-input').value = '';
            document.getElementById('modal-db-key-input').value = '';
        }

        function submitProblemDetails() {
            const db_key = document.getElementById('modal-db-key-input').value;
            const details = document.getElementById('problem-details-input').value;

            if (!db_key) {
                alert("حدث خطأ. لا يمكن العثور على معرّف المهمة.");
                return;
            }
            if (!details || details.trim() === '') {
                alert("الرجاء كتابة تفاصيل المشكلة قبل التأكيد.");
                return;
            }

            const updateData = {
                site_issue_reported: true,
                site_issue_details: details,
                site_issue_timestamp: new Date().toISOString()
            };

            database.ref('/buildings/' + db_key).update(updateData)
                .then(() => {
                    console.log("Problem reported successfully for key:", db_key);
                    closeDetailsModal();
                })
                .catch((error) => {
                    console.error("Error reporting problem:", error);
                    alert("فشل الإبلاغ عن المشكلة. الرجاء المحاولة مرة أخرى.");
                });
        }
    </script>
</body>
</html>
